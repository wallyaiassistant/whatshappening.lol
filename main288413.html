<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>whatshappening.lol</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="style.css">
    <meta property="og:title" content="whatshappening.lol">
    <meta property="og:description" content="Satirical Maltese news - when a small island nation incubates tribalism to ferment the finest satire.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://whatshappening.lol">
    <meta property="og:image" content="https://whatshappening.lol/logo.png">
</head>
<body>
    <header>
        <div class="header-inner">
            <div class="header-brand">
                <img src="logo.png" alt="whatshappening.lol logo" class="header-logo">
                <div class="header-text">
                    <h1>whatshappening.l<img src="images/maltese-o.svg" class="title-icon" alt="o">l</h1>
                    <p class="tagline">...when a small island nation incubates tribalism to ferment the finest satire.</p>
                </div>
            </div>
            <button class="team-btn" onclick="openArticle('the-team')">The Team</button>
        </div>
    </header>

    <main>
        <section class="top-articles">
            <!-- Article 1: Marmara Poll -->
            <div class="card" onclick="openArticle('marmara-poll-gap-narrows')">
                <div class="card-date">21/02/26, 9:30 PM &bull; Kyshawn Farrugia</div>
                <img src="images/marmara-poll-gap-narrows.jpg" alt="Two opposing crowds separated by a shrinking gap">
                <div class="card-title">Marmar√† Poll Shows Labour Lead Shrinking But Nobody Panic</div>
            </div>

            <!-- Article 2: Halland Silence -->
            <div class="card" onclick="openArticle('halland-silence')">
                <div class="card-date">21/02/26, 1:00 PM &bull; Shunique Farrugia</div>
                <img src="images/halland-silence.jpg" alt="Halland Hotel Silence">
                <div class="card-title">Government Masters Ancient Art of Strategic Deafness Over Halland Hotel Fiasco</div>
            </div>

            <!-- Article 3: Marathon Mayhem -->
            <div class="card" onclick="openArticle('marathon-mayhem')">
                <div class="card-date">21/02/26, 1:00 PM &bull; Kreshawn Grech</div>
                <img src="images/marathon-mayhem.jpg" alt="Marathon Traffic Chaos">
                <div class="card-title">LifeStar Marathon Meets Storm Damage: When Running Becomes an Extreme Sport</div>
            </div>

            <!-- Article 4: Eurovision Standoff -->
            <div class="card" onclick="openArticle('eurovision-standoff')">
                <div class="card-date">21/02/26, 1:00 PM &bull; Dyzanique Spiteri</div>
                <img src="images/eurovision-standoff.jpg" alt="Eurovision Artist Protest">
                <div class="card-title">150 Artists vs Government: Eurovision Row Escalates to Full Diplomatic Crisis</div>
            </div>
        </section>

        <section class="older-articles">
            <h2>Older Posts</h2>
            <ul>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('police-academy-venue'); return false;">
                        <img src="images/police_academy_venue.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">20/02/26, 8:00 PM</span>
                            Alleged Money Launderer Runs Illegal Venue Opposite Police Academy ‚Äî Nobody Notices
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('labour-hides-deputy'); return false;">
                        <img src="images/labour_hides_deputy.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">20/02/26, 8:15 PM</span>
                            The Night Labour Put Its Own Deputy Leader in Political Witness Protection
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('vacant-grants-panther'); return false;">
                        <img src="images/vacant_grants_panther.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">20/02/26, 8:30 PM</span>
                            Government Doubles Vacant Property Grants to ‚Ç¨50K ‚Äî Meanwhile, a Panther Roams Bormla
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('labour-rent-respect'); return false;">
                        <img src="images/labour_rent_respect.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">20/02/26, 8:45 PM</span>
                            Labour "Respects" Court Order After 70 Years of Paying ‚Ç¨400 Rent in Valletta
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('fawwara-quarry'); return false;">
                        <img src="images/fawwara_quarry.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">20/02/26, 10:00 AM</span>
                            PA Approves Quarry Expansion Despite Court Eviction Order
                        </div>
                    </a>
                </li>
            </ul>
        </section>

        <section class="archive-section">
            <a href="archive.html" class="archive-link">üìÅ Archive</a>
        </section>
    </main>

    <!-- Single reusable overlay container -->
    <div class="article-overlay" id="article-overlay">
        <div class="article-full">
            <button class="close-btn" onclick="closeArticle()">&times;</button>
            <div id="article-body">
                <div class="article-loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Contact Modal (kept inline - it's tiny) -->
    <div class="article-overlay" id="contact-modal">
        <div class="article-full contact-form-wrapper">
            <button class="close-btn" onclick="closeOverlay('contact-modal')">&times;</button>
            <div class="article-content">
                <h2>üì¨ Contact Us</h2>
                <form id="contact-form" action="https://formsubmit.co/8f3a75c8736b570ece0c16527dce5e6a" method="POST">
                    <div class="form-group"><input type="text" name="name" placeholder="Your name (optional)" class="form-input"></div>
                    <div class="form-group"><input type="email" name="email" placeholder="Your email (optional)" class="form-input"></div>
                    <div class="form-group"><textarea name="message" placeholder="Your message..." class="form-input" rows="5" required></textarea></div>
                    <button type="submit" class="share-btn fb" style="width:100%; justify-content:center; padding:0.7rem;">Send Message</button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 whatshappening.lol - All rights reserved.</p>
        <button class="contact-btn" onclick="openOverlay('contact-modal')">üì¨ Contact Us</button>
    </footer>

    <div class="toast" id="toast">Link copied!</div>

    <script>
        const BASE_URL = 'https://whatshappening.lol';
        const articleCache = {};

        // SVG icons for share buttons
        const ICONS = {
            fb: '<svg viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951"></path></svg>',
            x: '<svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>',
            wa: '<svg viewBox="0 0 24 24"><path d="M12.04 2.02c-5.52 0-9.99 4.47-9.99 9.99 0 1.77.46 3.45 1.26 4.93L2.06 22l5.24-1.36c1.44.75 3.09 1.19 4.74 1.19h.01c5.52 0 9.99-4.47 9.99-9.99s-4.47-9.99-9.99-9.99zM12.04 20.21c-1.55 0-3.03-.4-4.33-1.12L4.5 20l-1.07-3.21c-.8-1.35-1.28-2.9-1.28-4.52 0-4.54 3.68-8.22 8.22-8.22 4.54 0 8.22 3.68 8.22 8.22s-3.68 8.22-8.22 8.22zm4.49-5.89c-.28-.14-1.64-.81-1.89-.9s-.44-.14-.62.14-.71.9-.87 1.08-.32.19-.59.05c-.28-.14-1.16-.43-2.21-1.36-.82-.72-1.37-1.61-1.53-1.89-.16-.28-.02-.43.12-.57.13-.13.28-.34.42-.51.12-.14.16-.25.25-.42.09-.17.05-.31-.02-.45s-.62-1.5-.85-2.05-.46-.46-.62-.46h-.53c-.22 0-.46.08-.71.31s-.87.85-.87 2.07.9 2.4 1.02 2.57c.12.17 1.75 2.67 4.24 3.74 2.49 1.07 2.49.71 2.94.68.45-.03 1.45-.59 1.65-.9s.2-.59.14-.73c-.05-.14-.2-.23-.47-.37z"/></svg>',
            copy: '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'
        };

        function buildShareBar(slug) {
            const url = encodeURIComponent(`${BASE_URL}/main288413.html#${slug}`);
            const title = document.querySelector('#article-body h2')?.textContent || '';
            const encodedTitle = encodeURIComponent(title);
            return `
                <a class="share-btn fb" href="https://www.facebook.com/sharer/sharer.php?u=${url}" target="_blank" rel="noopener">${ICONS.fb}</a>
                <a class="share-btn x" href="https://x.com/intent/post?text=${encodedTitle}&url=${url}" target="_blank" rel="noopener">${ICONS.x}</a>
                <a class="share-btn wa" href="whatsapp://send?text=${encodedTitle}%20${decodeURIComponent(url)}" target="_blank" rel="noopener">${ICONS.wa}</a>
                <button class="share-btn copy" onclick="copyLink('${decodeURIComponent(url)}')">${ICONS.copy}</button>
            `;
        }

        // ---- Audio Player ----
        const AUDIO_SLUGS = [
            'halland-silence',
            'marathon-mayhem',
            'eurovision-standoff',
            'police-academy-venue',
            'labour-hides-deputy',
            'vacant-grants-panther',
            'labour-rent-respect',
            'fawwara-quarry',
            'fantasy-funpark'
        ];
        const PLAY_SVG = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
        const PAUSE_SVG = '<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6zm8 0h4v16h-4z"/></svg>';
        const SPEEDS = [1, 1.25, 1.5, 2];
        let audioEl = null;
        let audioSlug = null;
        let audioBias = null;
        let audioSpeedIdx = 0;
        let audioAnimFrame = null;

        function getAudioUrl(slug, bias) {
            return bias === 0 ? `audio/${slug}.mp3` : `audio/${slug}_bias_${bias}.mp3`;
        }

        function buildAudioPlayer(slug, bias) {
            if (!AUDIO_SLUGS.includes(slug)) return '';
            // Generate fake waveform bars (40 bars with varied heights)
            const seed = slug.length + Math.abs(bias);
            const bars = Array.from({length: 40}, (_, i) => {
                const h = 20 + Math.round(60 * Math.abs(Math.sin(i * 0.7 + seed)));
                return `<div class="audio-waveform-bar" style="height:${h}%" data-idx="${i}"></div>`;
            }).join('');
            return `
            <div class="audio-player" data-slug="${slug}" data-bias="${bias}">
                <button class="audio-play-btn" onclick="toggleAudio('${slug}',${bias})" title="Listen to article">${PLAY_SVG}</button>
                <div class="audio-progress-wrap">
                    <div class="audio-waveform" onclick="seekAudio(event)">${bars}</div>
                    <div class="audio-time-row">
                        <span class="audio-current">0:00</span>
                        <span class="audio-duration">-:--</span>
                    </div>
                </div>
                <button class="audio-speed-btn" onclick="cycleSpeed()">1√ó</button>
            </div>`;
        }

        function toggleAudio(slug, bias) {
            const player = document.querySelector('.audio-player');
            if (!player) return;
            const btn = player.querySelector('.audio-play-btn');

            // If switching to different article/bias, reset
            if (!audioEl || audioSlug !== slug || audioBias !== bias) {
                if (audioEl) { audioEl.pause(); cancelAnimationFrame(audioAnimFrame); }
                audioEl = new Audio(getAudioUrl(slug, bias));
                audioSlug = slug;
                audioBias = bias;
                audioSpeedIdx = 0;
                audioEl.playbackRate = SPEEDS[0];
                audioEl.addEventListener('loadedmetadata', () => updateDuration());
                audioEl.addEventListener('ended', () => {
                    btn.innerHTML = PLAY_SVG;
                    cancelAnimationFrame(audioAnimFrame);
                    updateWaveform(1); // fully played
                });
            }

            if (audioEl.paused) {
                audioEl.play();
                btn.innerHTML = PAUSE_SVG;
                animateProgress();
            } else {
                audioEl.pause();
                btn.innerHTML = PLAY_SVG;
                cancelAnimationFrame(audioAnimFrame);
            }
        }

        function animateProgress() {
            if (!audioEl || audioEl.paused) return;
            const pct = audioEl.duration ? audioEl.currentTime / audioEl.duration : 0;
            updateWaveform(pct);
            updateCurrentTime();
            audioAnimFrame = requestAnimationFrame(animateProgress);
        }

        function updateWaveform(pct) {
            const bars = document.querySelectorAll('.audio-waveform-bar');
            const playedCount = Math.floor(pct * bars.length);
            bars.forEach((bar, i) => {
                bar.classList.toggle('played', i < playedCount);
            });
        }

        function updateCurrentTime() {
            const el = document.querySelector('.audio-current');
            if (el && audioEl) el.textContent = fmtTime(audioEl.currentTime);
        }

        function updateDuration() {
            const el = document.querySelector('.audio-duration');
            if (el && audioEl) el.textContent = fmtTime(audioEl.duration);
        }

        function fmtTime(s) {
            if (!s || !isFinite(s)) return '-:--';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }

        function seekAudio(e) {
            if (!audioEl || !audioEl.duration) return;
            const waveform = e.currentTarget;
            const rect = waveform.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audioEl.currentTime = pct * audioEl.duration;
            updateWaveform(pct);
            updateCurrentTime();
        }

        function cycleSpeed() {
            if (!audioEl) return;
            audioSpeedIdx = (audioSpeedIdx + 1) % SPEEDS.length;
            audioEl.playbackRate = SPEEDS[audioSpeedIdx];
            const btn = document.querySelector('.audio-speed-btn');
            if (btn) btn.textContent = SPEEDS[audioSpeedIdx] + '√ó';
        }

        function swapAudioForBias(slug, bias) {
            // Called when bias notch changes - swap audio source
            const player = document.querySelector('.audio-player');
            if (!player) return;
            const wasPlaying = audioEl && !audioEl.paused && audioSlug === slug;
            if (audioEl) { audioEl.pause(); cancelAnimationFrame(audioAnimFrame); }
            audioEl = new Audio(getAudioUrl(slug, bias));
            audioSlug = slug;
            audioBias = bias;
            audioEl.playbackRate = SPEEDS[audioSpeedIdx];
            audioEl.addEventListener('loadedmetadata', () => updateDuration());
            audioEl.addEventListener('ended', () => {
                player.querySelector('.audio-play-btn').innerHTML = PLAY_SVG;
                cancelAnimationFrame(audioAnimFrame);
                updateWaveform(1);
            });
            // Reset UI
            player.dataset.bias = bias;
            player.querySelector('.audio-play-btn').innerHTML = PLAY_SVG;
            document.querySelector('.audio-current').textContent = '0:00';
            document.querySelector('.audio-duration').textContent = '-:--';
            updateWaveform(0);
        }

        // Cache neutral titles per slug - bias variants always show the neutral title
        const neutralTitles = {};

        async function cacheNeutralTitle(slug) {
            if (neutralTitles[slug]) return;
            try {
                const resp = await fetch(`articles/${slug}.html`);
                if (resp.ok) {
                    const html = await resp.text();
                    const match = html.match(/<h2>(.*?)<\/h2>/s);
                    if (match) neutralTitles[slug] = match[1];
                }
            } catch(e) {}
        }

        function enforceNeutralTitle(slug) {
            if (!neutralTitles[slug]) return;
            const h2 = document.querySelector('#article-body h2');
            if (h2) h2.innerHTML = neutralTitles[slug];
        }

        const BIAS_API = 'https://bias-slider.wallyaiassistant.workers.dev/api/bias';
        const BIAS_LABELS = {
            '-3': 'Full PN spin',
            '-2': 'Heavy PN lean',
            '-1': 'Slight PN lean',
            '0': 'Neutral',
            '1': 'Slight PL lean',
            '2': 'Heavy PL lean',
            '3': 'Full PL spin'
        };

        const LEVEL_POSITIONS = { '-3': '0%', '-2': '16.67%', '-1': '33.33%', '0': '50%', '1': '66.67%', '2': '83.33%', '3': '100%' };

        function buildBiasSlider(slug, level) {
            const notches = [-3,-2,-1,0,1,2,3].map(n =>
                `<div class="bias-notch${n === level ? ' active' : ''}" data-notch="${n}" onclick="previewBias('${slug}',${n})" title="${BIAS_LABELS[String(n)]}"></div>`
            ).join('');
            return `
            <div class="bias-slider" data-slug="${slug}" data-level="${level}">
                <div class="bias-label-row">
                    <span class="bias-label-blue">Nazzjonalisti sal-mewt</span>
                    <span class="bias-label-red">Laburisti sal-mewt</span>
                </div>
                <div class="bias-track-wrapper">
                    <button class="bias-arrow blue" onclick="shiftBias('${slug}','blue')" title="Shift toward PN">‚óÄ</button>
                    <div class="bias-track">
                        <div class="bias-pointer-wrapper" style="left:${LEVEL_POSITIONS[String(level)]}">
                            <div class="bias-pointer" data-level="${level}"></div>
                        </div>
                        ${notches}
                    </div>
                    <button class="bias-arrow red" onclick="shiftBias('${slug}','red')" title="Shift toward PL">‚ñ∂</button>
                </div>
                <div class="bias-level-text">${BIAS_LABELS[String(level)] || 'Neutral'}</div>
            </div>`;
        }

        async function fetchBiasLevel(slug) {
            try {
                const r = await fetch(`${BIAS_API}/${slug}`);
                const d = await r.json();
                return d.bias || 0;
            } catch { return 0; }
        }

        async function previewBias(slug, level) {
            const body = document.getElementById('article-body');
            const articleFile = level === 0
                ? `articles/${slug}.html`
                : `articles/${slug}_bias_${level}.html`;
            try {
                let resp = await fetch(articleFile);
                if (!resp.ok) resp = await fetch(`articles/${slug}.html`);
                if (!resp.ok) return;
                const html = await resp.text();
                const sliderHtml = buildBiasSlider(slug, level);
                const combined = html.replace('<p class="meta">', sliderHtml + '<p class="meta">');
                body.innerHTML = combined;
                enforceNeutralTitle(slug);
                hydrateShareBars(slug, level);
                // Swap audio source if it was playing
                swapAudioForBias(slug, level);
                // Persist to KV so all visitors see this level
                setBiasLevel(slug, level);
            } catch(e) {}
        }

        async function setBiasLevel(slug, level) {
            try {
                await fetch(`${BIAS_API}/${slug}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });
            } catch(e) {}
        }

        async function shiftBias(slug, direction) {
            const slider = document.querySelector('.bias-slider[data-slug="' + slug + '"]');
            const current = parseInt(slider?.dataset.level || '0', 10);
            const newLevel = direction === 'blue'
                ? Math.max(-3, current - 1)
                : Math.min(3, current + 1);
            if (newLevel !== current) previewBias(slug, newLevel);
        }

        async function openArticle(slug) {
            const overlay = document.getElementById('article-overlay');
            const body = document.getElementById('article-body');

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            history.pushState({articleSlug: slug}, '', '#' + slug);

            body.innerHTML = '<div class="article-loading">Loading...</div>';

            try {
                // Cache the neutral title before loading any variant
                await cacheNeutralTitle(slug);
                // Always fetch fresh bias level from Worker
                const biasLevel = await fetchBiasLevel(slug);
                const articleFile = biasLevel === 0
                    ? `articles/${slug}.html`
                    : `articles/${slug}_bias_${biasLevel}.html`;
                let resp = await fetch(articleFile);
                if (!resp.ok) resp = await fetch(`articles/${slug}.html`);
                if (!resp.ok) throw new Error('Not found');
                let html = await resp.text();

                // FIX: Inject image if missing (for new articles)
                if (!html.includes('<img')) {
                    const imgSlug = slug.replace(/-/g, '_');
                    const imgTag = `<img src="images/${imgSlug}.jpg" alt="Article Image" class="article-hero" style="width:100%; height:auto; display:block; margin-bottom:1rem; border-radius:8px;">`;
                    // Inject at top
                    html = imgTag + html;
                }

                const sliderHtml = buildBiasSlider(slug, biasLevel);
                const combined = html.replace(
                    '<p class="meta">',
                    sliderHtml + '<p class="meta">'
                );
                body.innerHTML = combined;
                enforceNeutralTitle(slug);
                hydrateShareBars(slug, biasLevel);
                // Reset audio state for new article
                if (audioEl) { audioEl.pause(); cancelAnimationFrame(audioAnimFrame); }
                audioEl = null; audioSlug = null; audioBias = null;
            } catch (e) {
                body.innerHTML = '<div class="article-content"><h2>Article not found</h2><p class="commentary">Sorry, this article could not be loaded.</p></div>';
            }
        }

        function hydrateShareBars(slug, bias) {
            document.querySelectorAll('#article-body .share-bar[data-slug]').forEach(bar => {
                const s = slug || bar.dataset.slug;
                const b = bias !== undefined ? bias : 0;
                bar.innerHTML = buildShareBar(bar.dataset.slug) + buildAudioPlayer(s, b);
            });
        }

        function closeArticle() {
            const overlay = document.getElementById('article-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            history.pushState(null, '', window.location.pathname);
        }

        function openOverlay(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeOverlay(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }

        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.articleSlug) {
                openArticle(e.state.articleSlug);
            } else {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    openArticle(hash);
                } else {
                    document.getElementById('article-overlay').classList.remove('active');
                    document.getElementById('contact-modal').classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1);
            if (hash) setTimeout(() => openArticle(hash), 100);
        });

        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }
    </script>
</body>
</html>