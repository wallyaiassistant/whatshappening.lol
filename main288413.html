<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>whatshappening.lol</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="style.css">
    <meta property="og:title" content="whatshappening.lol">
    <meta property="og:description" content="Satirical Maltese news ‚Äî because small islands with megalomaniac mindsets ferment the finest satire.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://whatshappening.lol">
    <meta property="og:image" content="https://whatshappening.lol/logo.png">
</head>
<body>
    <header>
        <div class="header-inner">
            <div class="header-brand">
                <img src="logo.png" alt="whatshappening.lol logo" class="header-logo">
                <div class="header-text">
                    <h1>whatshappening.l<img src="images/maltese-o.svg" class="title-icon" alt="o">l</h1>
                    <p class="tagline">...because small islands with megalomaniac mindsets ferment the finest satire.</p>
                </div>
            </div>
            <button class="team-btn" onclick="openArticle('the-team')">The Team</button>
        </div>
    </header>

    <main>
        <section class="top-articles">
            <!-- Article 1: Bormla Panther -->
            <div class="card" onclick="openArticle('bormla-panther')">
                <div class="card-date">19/02/26, 10:30 AM &bull; Kayzielle Camilleri</div>
                <img src="images/bormla_panther.jpg" alt="The Bormla Panther">
                <div class="card-title">The Bormla Panther: Malta Mobilises After Terrifying Stray Cat Sighting</div>
            </div>
            
            <!-- Article 2: Ta' Qali Concession -->
            <div class="card" onclick="openArticle('taqali-concession')">
                <div class="card-date">19/02/26, 10:45 AM &bull; Shunique Farrugia</div>
                <img src="images/taqali_concession.jpg" alt="Ta Qali 50-Year Concession">
                <div class="card-title">Occupy Land Illegally for Decades? Here's Your 50-Year Deal, Sir</div>
            </div>

            <!-- Article 3: President's Wages -->
            <div class="card" onclick="openArticle('president-wages')">
                <div class="card-date">18/02/26, 6:00 PM &bull; Shanazaya Vella</div>
                <img src="images/president_wages.jpg" alt="President Solves Voter Apathy">
                <div class="card-title">President Solves Voter Apathy: "Have We Tried Paying Politicians More?"</div>
            </div>

            <!-- Article 4: Board of Peace -->
            <div class="card" onclick="openArticle('board-split')">
                <div class="card-date">18/02/26, 6:15 PM &bull; Dwaynzia Borg</div>
                <img src="images/board_of_peace_split.jpg" alt="Robert's Billion-Dollar Seat">
                <div class="card-title">Robert's Billion-Dollar Seat: Will Malta Join Trump's VIP Club or Listen to Jason's Common Sense?</div>
            </div>
        </section>

        <section class="older-articles">
            <h2>Older Posts</h2>
            <ul>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('ngo-gravel'); return false;">
                        <img src="images/ngo_gravel_controversy.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">17/02/26, 10:35 PM</span>
                            The Standard of Charity: Why Some NGOs Get Civil Servants and Others Get Ta' Qali Gravel
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('carnival-wind'); return false;">
                        <img src="images/carnival_chaos_weather_woes.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">17/2/26, 8:40 PM</span>
                            Malta's Carnival Blown Away: The Wind, They Say, Was 'Unexpected'
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('board-of-peace'); return false;">
                        <img src="images/2026-02-17-board-of-peace.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">17/2/26, 2:45 PM</span>
                            Robert's Billion-Dollar Seat: Will Malta Join Trump's VIP Club? (Early Reports)
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('botox-storm'); return false;">
                        <img src="images/storm-malta.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">17/2/26, 11:30 AM</span>
                            National Priorities: Half of Malta Braces for Storm, Other Half Braces for Botox
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="archive-item" onclick="openArticle('plastic-fish'); return false;">
                        <img src="images/plastic-pollution.jpg" alt="Article thumbnail" class="archive-thumbnail">
                        <div class="archive-text-content">
                            <span class="archive-date">17/2/26, 11:00 AM</span>
                            Malta Celebrates Record Recycling, As Marine Teams Discover New Plastic Fish Species
                        </div>
                    </a>
                </li>
            </ul>
        </section>

        <section class="archive-section">
            <a href="archive.html" class="archive-link">üìÅ Archive</a>
        </section>
    </main>

    <!-- Single reusable overlay container -->
    <div class="article-overlay" id="article-overlay">
        <div class="article-full">
            <button class="close-btn" onclick="closeArticle()">&times;</button>
            <div id="article-body">
                <div class="article-loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Contact Modal (kept inline - it's tiny) -->
    <div class="article-overlay" id="contact-modal">
        <div class="article-full contact-form-wrapper">
            <button class="close-btn" onclick="closeOverlay('contact-modal')">&times;</button>
            <div class="article-content">
                <h2>üì¨ Contact Us</h2>
                <form id="contact-form" action="https://formsubmit.co/8f3a75c8736b570ece0c16527dce5e6a" method="POST">
                    <div class="form-group"><input type="text" name="name" placeholder="Your name (optional)" class="form-input"></div>
                    <div class="form-group"><input type="email" name="email" placeholder="Your email (optional)" class="form-input"></div>
                    <div class="form-group"><textarea name="message" placeholder="Your message..." class="form-input" rows="5" required></textarea></div>
                    <button type="submit" class="share-btn fb" style="width:100%; justify-content:center; padding:0.7rem;">Send Message</button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 whatshappening.lol ‚Äî All rights reserved.</p>
        <button class="contact-btn" onclick="openOverlay('contact-modal')">üì¨ Contact Us</button>
    </footer>

    <div class="toast" id="toast">Link copied!</div>

    <script>
        const BASE_URL = 'https://whatshappening.lol';
        const articleCache = {};

        // SVG icons for share buttons
        const ICONS = {
            fb: '<svg viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951"></path></svg>',
            x: '<svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>',
            wa: '<svg viewBox="0 0 24 24"><path d="M12.04 2.02c-5.52 0-9.99 4.47-9.99 9.99 0 1.77.46 3.45 1.26 4.93L2.06 22l5.24-1.36c1.44.75 3.09 1.19 4.74 1.19h.01c5.52 0 9.99-4.47 9.99-9.99s-4.47-9.99-9.99-9.99zM12.04 20.21c-1.55 0-3.03-.4-4.33-1.12L4.5 20l-1.07-3.21c-.8-1.35-1.28-2.9-1.28-4.52 0-4.54 3.68-8.22 8.22-8.22 4.54 0 8.22 3.68 8.22 8.22s-3.68 8.22-8.22 8.22zm4.49-5.89c-.28-.14-1.64-.81-1.89-.9s-.44-.14-.62.14-.71.9-.87 1.08-.32.19-.59.05c-.28-.14-1.16-.43-2.21-1.36-.82-.72-1.37-1.61-1.53-1.89-.16-.28-.02-.43.12-.57.13-.13.28-.34.42-.51.12-.14.16-.25.25-.42.09-.17.05-.31-.02-.45s-.62-1.5-.85-2.05-.46-.46-.62-.46h-.53c-.22 0-.46.08-.71.31s-.87.85-.87 2.07.9 2.4 1.02 2.57c.12.17 1.75 2.67 4.24 3.74 2.49 1.07 2.49.71 2.94.68.45-.03 1.45-.59 1.65-.9s.2-.59.14-.73c-.05-.14-.2-.23-.47-.37z"/></svg>',
            copy: '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'
        };

        function buildShareBar(slug) {
            const url = encodeURIComponent(`${BASE_URL}/main288413.html#${slug}`);
            const title = document.querySelector('#article-body h2')?.textContent || '';
            const encodedTitle = encodeURIComponent(title);
            return `
                <a class="share-btn fb" href="https://www.facebook.com/sharer/sharer.php?u=${url}" target="_blank" rel="noopener">${ICONS.fb}</a>
                <a class="share-btn x" href="https://x.com/intent/post?text=${encodedTitle}&url=${url}" target="_blank" rel="noopener">${ICONS.x}</a>
                <a class="share-btn wa" href="whatsapp://send?text=${encodedTitle}%20${decodeURIComponent(url)}" target="_blank" rel="noopener">${ICONS.wa}</a>
                <button class="share-btn copy" onclick="copyLink('${decodeURIComponent(url)}')">${ICONS.copy}</button>
            `;
        }

        const BIAS_API = 'https://bias-slider.wallyaiassistant.workers.dev/api/bias';
        const BIAS_LABELS = {
            '-3': 'Full PN spin',
            '-2': 'Heavy PN lean',
            '-1': 'Slight PN lean',
            '0': 'Neutral',
            '1': 'Slight PL lean',
            '2': 'Heavy PL lean',
            '3': 'Full PL spin'
        };

        const LEVEL_POSITIONS = { '-3': '0%', '-2': '16.67%', '-1': '33.33%', '0': '50%', '1': '66.67%', '2': '83.33%', '3': '100%' };

        function buildBiasSlider(slug, level) {
            const notches = [-3,-2,-1,0,1,2,3].map(n =>
                `<div class="bias-notch${n === level ? ' active' : ''}" data-notch="${n}" onclick="previewBias('${slug}',${n})" title="${BIAS_LABELS[String(n)]}"></div>`
            ).join('');
            return `
            <div class="bias-slider" data-slug="${slug}" data-level="${level}">
                <div class="bias-label-row">
                    <span class="bias-label-blue">Nazzjonalisti sal-mewt</span>
                    <span class="bias-label-red">Laburisti sal-mewt</span>
                </div>
                <div class="bias-track-wrapper">
                    <button class="bias-arrow blue" onclick="shiftBias('${slug}','blue')" title="Shift toward PN">‚óÄ</button>
                    <div class="bias-track">
                        <div class="bias-pointer-wrapper" style="left:${LEVEL_POSITIONS[String(level)]}">
                            <div class="bias-pointer" data-level="${level}"></div>
                        </div>
                        ${notches}
                    </div>
                    <button class="bias-arrow red" onclick="shiftBias('${slug}','red')" title="Shift toward PL">‚ñ∂</button>
                </div>
                <div class="bias-level-text">${BIAS_LABELS[String(level)] || 'Neutral'}</div>
            </div>`;
        }

        async function fetchBiasLevel(slug) {
            try {
                const r = await fetch(`${BIAS_API}/${slug}`);
                const d = await r.json();
                return d.bias || 0;
            } catch { return 0; }
        }

        async function previewBias(slug, level) {
            const body = document.getElementById('article-body');
            const articleFile = level === 0
                ? `articles/${slug}.html`
                : `articles/${slug}_bias_${level}.html`;
            try {
                let resp = await fetch(articleFile);
                if (!resp.ok) resp = await fetch(`articles/${slug}.html`);
                if (!resp.ok) return;
                const html = await resp.text();
                const sliderHtml = buildBiasSlider(slug, level);
                const combined = html.replace('<p class="meta">', sliderHtml + '<p class="meta">');
                body.innerHTML = combined;
                hydrateShareBars();
                // Persist to KV so all visitors see this level
                setBiasLevel(slug, level);
            } catch(e) {}
        }

        async function setBiasLevel(slug, level) {
            try {
                await fetch(`${BIAS_API}/${slug}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });
            } catch(e) {}
        }

        async function shiftBias(slug, direction) {
            const slider = document.querySelector('.bias-slider[data-slug="' + slug + '"]');
            const current = parseInt(slider?.dataset.level || '0', 10);
            const newLevel = direction === 'blue'
                ? Math.max(-3, current - 1)
                : Math.min(3, current + 1);
            if (newLevel !== current) previewBias(slug, newLevel);
        }

        async function openArticle(slug) {
            const overlay = document.getElementById('article-overlay');
            const body = document.getElementById('article-body');

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            history.pushState({articleSlug: slug}, '', '#' + slug);

            body.innerHTML = '<div class="article-loading">Loading...</div>';

            try {
                // Always fetch fresh bias level from Worker
                const biasLevel = await fetchBiasLevel(slug);
                const articleFile = biasLevel === 0
                    ? `articles/${slug}.html`
                    : `articles/${slug}_bias_${biasLevel}.html`;
                let resp = await fetch(articleFile);
                if (!resp.ok) resp = await fetch(`articles/${slug}.html`);
                if (!resp.ok) throw new Error('Not found');
                const html = await resp.text();
                const sliderHtml = buildBiasSlider(slug, biasLevel);
                const combined = html.replace(
                    '<p class="meta">',
                    sliderHtml + '<p class="meta">'
                );
                body.innerHTML = combined;
                hydrateShareBars();
            } catch (e) {
                body.innerHTML = '<div class="article-content"><h2>Article not found</h2><p class="commentary">Sorry, this article could not be loaded.</p></div>';
            }
        }

        function hydrateShareBars() {
            document.querySelectorAll('#article-body .share-bar[data-slug]').forEach(bar => {
                bar.innerHTML = buildShareBar(bar.dataset.slug);
            });
        }

        function closeArticle() {
            const overlay = document.getElementById('article-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            history.pushState(null, '', window.location.pathname);
        }

        function openOverlay(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeOverlay(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }

        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.articleSlug) {
                openArticle(e.state.articleSlug);
            } else {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    openArticle(hash);
                } else {
                    document.getElementById('article-overlay').classList.remove('active');
                    document.getElementById('contact-modal').classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1);
            if (hash) setTimeout(() => openArticle(hash), 100);
        });

        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }
    </script>
</body>
</html>